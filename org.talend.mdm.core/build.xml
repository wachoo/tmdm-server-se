<?xml version="1.0" encoding="UTF-8"?>
<!-- ====================================================================== 
     20 dÃ©c. 2005 09:21:22                                                        

     Xtentis Core
     Core Modules of Xtentis
                   
     bgrieder                                                                
     ====================================================================== -->
<project name="XtentisCore - Build" default="all">
    <description>
            Xtentis Core
    </description>

	<property name="version.props" value="product_version.properties"/>
		
	<property name="jboss.dir" value="/home/pascal/dev/jboss/jboss-4.2.2.GA-mdm"/>
	<property name="jboss.instance.dir" value="${jboss.dir}/server/default"/>
	<property name="jboss.deploy.dir" value="${jboss.instance.dir}/deploy"/>
	<property name="jboss.lib.dir" value="${jboss.instance.dir}/lib"/>
	<property name="jboss.bin.dir" value="${jboss.dir}/bin"/>

	<property name="war" value="zz.30.core.war"/>
	<property name="ejbs" value="zz.20.core.jar"/>
	<property name="lib" value="z.mdm.core.jar"/>
	<property name="conf" value="mdm.conf"/>
	<property name="conf.template" value="mdm.conf.template"/>
	<property name="svn.revision" value="36233"/>

    <property name="tom.location" value="${basedir}/.." />

    <!-- =================================
          target: all              
         ================================= -->
	<target name="all" depends="version,package,undeploy,deploy">
		<!-- <eclipse.refreshLocal resource="${basedir}"/> -->
	</target>

    <target name="junit">
      <echo message="${tom.location}/talend.mdm.libraries/lib/junit-3.8.1.jar"/>

      <delete dir="${basedir}/target/test-classes" />
      <mkdir dir="${basedir}/target/test-classes" />

      <delete dir="${basedir}/target/test-reports" />
      <mkdir dir="${basedir}/target/test-reports" />

      <path id="base.classpath">
        <pathelement path="bin" />
        <pathelement path="${tom.location}/org.talend.mdm.core/bin" />
        <pathelement path="${tom.location}/talend.mdm.libraries/lib/z.commons-lang-2.1.jar"/>
        <pathelement path="${tom.location}/talend.mdm.libraries/lib/log4j.jar" />
        <pathelement path="${tom.location}/talend.mdm.libraries/lib/servlet-api.jar" />
        <pathelement path="${tom.location}/org.talend.mdm.commmon/bin" />
      </path>

      <path id="compile.classpath">
        <pathelement path="${tom.location}/talend.mdm.libraries/lib/junit-3.8.1.jar" />
        <pathelement path="${tom.location}/talend.mdm.libraries/lib/z.jazzy-core.jar" />
        <pathelement path="${tom.location}/talend.mdm.libraries/lib/z.castor-1.0.5-xml.jar" />
        <pathelement path="${tom.location}/talend.mdm.libraries/lib/commons-logging.jar" />
        <pathelement path="${tom.location}/talend.mdm.libraries/lib/jboss-j2ee.jar" />
        <path refid="base.classpath" />
      </path>

      <path id="test.classpath">
        <pathelement path="target/test-classes" />
        <path refid="compile.classpath" />
      </path>

      <copy todir="${basedir}/target/test-classes" verbose="true">
        <fileset dir="${basedir}/test" excludes="**/*.java"/>
      </copy>

      <javac srcdir="${basedir}/test" destdir="${basedir}/target/test-classes">
        <classpath>
          <path refid="compile.classpath" />
        </classpath>
      </javac>

      <junit printsummary="yes" haltonfailure="yes" showoutput="yes">
        <classpath>
          <path refid="test.classpath" />
        </classpath>

        <batchtest fork="yes" todir="target/test-reports">
          <fileset dir="target/test-classes">
            <include name="**/*Test.class" />
          </fileset>
        </batchtest>

        <formatter type="plain" />
        <formatter type="xml" />
      </junit>
    </target>

   	<target name="version"  description="Maintain build.date property">
   		<buildnumber file="${version.props}" />
   		<echo>Revision Number :${svn.revision}</echo>
   		<loadproperties srcfile="${version.props}"></loadproperties>
       	<propertyfile file="${version.props}">
       		<entry key="build.date" type="date" value="now" />
       		<entry key="build.number" value="${svn.revision}" />
       		<entry key="major" value="${major}" />
       		<entry key="minor" value="${minor}" />
       		<entry key="rev" value="${rev}" />
       	</propertyfile>   	
     </target>

   	<target name="package" depends="version, junit">
   		
		<jar destfile="${ejbs}" manifest="src/META-INF/MANIFEST.MF">

			<zipfileset dir=".">
				<include name="RELEASE.NOTES" />
			</zipfileset>
			<zipfileset dir=".">
				<include name="${version.props}" />
			</zipfileset>
			<zipfileset dir="bin" includes="**/*.class" />
			<zipfileset dir="src" excludes="**/*.java"/>
		</jar>
   		
   		<!-- used by transformer plugins -->
		<jar destfile="${lib}" manifest="src/META-INF/MANIFEST.MF">
			<zipfileset dir=".">
				<include name="${version.props}" />
			</zipfileset>
			<zipfileset dir=".">
				<include name="RELEASE.NOTES" />
			</zipfileset>
			<zipfileset dir="bin" includes="**/util/*.class" />
			<zipfileset dir="bin" includes="**/*POJO*.class" />
		</jar>
   		
		<jar destfile="${war}" manifest="src/META-INF/MANIFEST.MF">
			<zipfileset dir="src/WEB-INF" prefix="WEB-INF">
				<include name="web.xml" />
			</zipfileset>
			<zipfileset dir="src/WEB-INF" prefix="WEB-INF">
				<include name="jboss-web.xml" />
			</zipfileset>
			<zipfileset dir=".">
				<include name="${version.props}" />
			</zipfileset>
			<zipfileset dir=".">
				<include name="RELEASE.NOTES" />
			</zipfileset>
			<zipfileset dir="bin" prefix="WEB-INF/classes" includes="**/servlet/*.class" />
			<zipfileset dir="src" includes="WEB-INF/lib/*.*" />
		</jar>
   		
    </target>

		
    <target name="undeploy" description="remove packages">		
		<delete>
			<fileset dir="${jboss.lib.dir}" includes="${lib}"/>
			<fileset dir="${jboss.deploy.dir}" includes="${ejbs}"/>
			<fileset dir="${jboss.deploy.dir}" includes="${war}"/>
			<fileset dir="${jboss.bin.dir}" includes="${conf}"/>
			<fileset dir="${jboss.bin.dir}" includes="${conf.template}"/>
		</delete>
    </target>
	
	<target name="deploy">
		<echo>Deploying ${ejbs}, ${war} ${lib} and ${conf}</echo>
	
		<copy file="${lib}" tofile="${jboss.lib.dir}/${lib}"/>	 
		<copy file="${ejbs}" tofile="${jboss.deploy.dir}/${ejbs}"/>
		<copy file="${war}" tofile="${jboss.deploy.dir}/${war}"/>
		<copy file="${conf}" tofile="${jboss.bin.dir}/${conf}"/>
		<copy file="${conf.template}" tofile="${jboss.bin.dir}/${conf.template}"/>
    </target>

</project>
